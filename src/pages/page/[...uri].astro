---
import Layout from "../../layouts/Layout.astro";
import {
  getPageByURI,
  getPages,
  getAllPageURIs,
} from "../../lib/graphql-queries";
import type { Page } from "../../types/types";

export async function getStaticPaths() {
  let uris: string[];
  try {
    uris = await getAllPageURIs();
  } catch (error) {
    console.error("Failed to fetch page URIs:", error);
    uris = [];
  }
  return uris.map((uri) => ({ params: { uri } }));
}

const { uri } = Astro.params;
let page: Page | null = null;
let pages: Page[] = [];
let error: Error | null = null;

try {
  [page, pages] = await Promise.all([getPageByURI(uri || "home"), getPages()]);
} catch (e) {
  console.error("Error fetching data:", e);
  error = e instanceof Error ? e : new Error("An unknown error occurred");
}
---

<Layout title={page?.title || "Página no encontrada"}>
  {
    error ? (
      <p>
        Hubo un problema al cargar el contenido. Por favor, intenta recargar la
        página.
      </p>
    ) : page ? (
      <main>
        <article>
          <h1>{page.title}</h1>
          <div set:html={page.content} />
        </article>
      </main>
    ) : (
      <p>Página no encontrada.</p>
    )
  }
</Layout>
