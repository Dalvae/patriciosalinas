---
import Layout from "../../../layouts/Layout.astro";
import ProtectedImage from "../../../components/ProtectedImage.astro";
import { getPageByURI, getAllPages } from "../../../lib/graphql-queries";
import type { ProcessedPage, Lang } from "../../../types/types";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";

export async function getStaticPaths() {
  const pages = await getAllPages();
  return pages.map((page) => {
    const pathParts = page.uri.split("/").filter(Boolean);
    const lang = getLangFromUrl(new URL(page.uri, "http://example.com"));
    const uri = pathParts.slice(1).join("/") || undefined;
    return {
      params: { lang, uri },
      props: { pageData: page },
    };
  });
}

const { lang, uri } = Astro.params as { lang: Lang; uri?: string };
const { pageData } = Astro.props;
const t = useTranslations(lang);

let page: ProcessedPage | null = pageData;
let error: Error | null = null;

if (!page && lang && uri) {
  try {
    page = (await getPageByURI(`/${lang}/${uri}`)) as ProcessedPage;
  } catch (e) {
    console.error("Error fetching page:", e);
    error = e instanceof Error ? e : new Error("An unknown error occurred");
  }
}
---

<Layout title={page?.title || "Patricio Salinas"}>
  {
    error ? (
      <p>{t("error.loading")}</p>
    ) : page ? (
      <main>
        <h1>{page.title}</h1>
        {page.headers.map((header) => (
          <h2 set:html={header} />
        ))}
        {page.images.map((image) => (
          <ProtectedImage
            src={image.src}
            alt={image.alt}
            width={image.width}
            height={image.height}
          />
        ))}
        {page.paragraphs.map((paragraph) => (
          <p set:html={paragraph} />
        ))}
      </main>
    ) : (
      <p>{t("error.loading")}</p>
    )
  }
</Layout>
